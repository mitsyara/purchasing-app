<?php

namespace App\Filament\Resources\InventoryAdjustments;

use App\Filament\Resources\InventoryAdjustments\Pages\ManageInventoryAdjustments;
use App\Filament\Resources\InventoryTransactions\InventoryTransactionResource;
use App\Models\InventoryAdjustment;
use App\Models\InventoryAdjustmentLine;
use Filament\Actions as A;
use Filament\Resources\Resource;
use Filament\Schemas\Schema;
use Filament\Support\Icons\Heroicon;
use Filament\Tables\Table;

use Filament\Forms\Components as F;
use Filament\Schemas\Components as S;
use Filament\Schemas\Components\Utilities\Get;
use Filament\Schemas\Components\Utilities\Set;
use Filament\Tables\Columns as T;
use Illuminate\Database\Eloquent\Builder;

class InventoryAdjustmentResource extends Resource
{
    protected static ?string $model = InventoryAdjustment::class;

    protected static string|\BackedEnum|null $navigationIcon = Heroicon::OutlinedArrowsUpDown;

    protected static string|\UnitEnum|null $navigationGroup = 'inventory';

    protected static ?int $navigationSort = 32;

    public static function getNavigationParentItem(): ?string
    {
        return InventoryTransactionResource::getNavigationLabel();
    }

    public static function form(Schema $schema): Schema
    {
        return $schema
            ->components([
                S\Tabs::make('Adjustments')
                    ->tabs([
                        S\Tabs\Tab::make('General Info')
                            ->schema([
                                ...static::adjustmentInfo(),
                            ])
                            ->columns(),

                        S\Tabs\Tab::make('Details')
                            ->schema([
                                ...static::linesInfo(),
                            ])
                    ])
                    ->columnSpanFull(),
            ]);
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                T\TextColumn::make('adjustment_date')
                    ->label('Adjustment Date')
                    ->date('d/m/Y')
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),

                T\TextColumn::make('adjustment_status')
                    ->label('Status')
                    ->description(fn(InventoryAdjustment $record): string => $record->adjustment_date?->format('d/m/Y'))
                    ->sortable(),

                T\TextColumn::make('company.company_name')
                    ->label('Company')
                    ->searchable()
                    ->sortable(),

                T\TextColumn::make('warehouse.warehouse_name')
                    ->label('Warehouse')
                    ->searchable()
                    ->sortable(),

                T\TextColumn::make('reason')
                    ->label('Reason')
                    ->limit(30)
                    ->searchable(),

                T\TextColumn::make('adjustmentsLines.product.product_description')
                    ->label('Products')
                    ->distinctList()
                    ->listWithLineBreaks()
                    ->limitList(2)
                    ->expandableLimitedList()
                    ->badge(),
            ])
            ->filters([
                //
            ])
            ->recordActions([
                A\ActionGroup::make([
                    A\EditAction::make()
                        ->slideOver()
                        ->modalWidth(\Filament\Support\Enums\Width::FiveExtraLarge)
                        ->fillForm(fn(InventoryAdjustment $record) => static::helper()->loadFormData($record))
                        ->mutateDataUsing(fn(A\EditAction $action, array $data): array
                        => static::helper()->syncData($action, $data)),

                    A\DeleteAction::make(),
                ]),
            ])
            ->toolbarActions([
                A\BulkActionGroup::make([
                    A\DeleteBulkAction::make(),
                ]),
            ]);
    }

    public static function getPages(): array
    {
        return [
            'index' => ManageInventoryAdjustments::route('/'),
        ];
    }

    // Form fields

    /**
     * Form chính
     */
    public static function adjustmentInfo(): array
    {
        return [
            S\Flex::make([
                F\Select::make('company_id')
                    ->relationship(
                        name: 'company',
                        titleAttribute: 'company_name',
                        modifyQueryUsing: fn(Builder $query): Builder
                        => $query
                    )
                    ->required(),

                F\Select::make('warehouse_id')
                    ->relationship(
                        name: 'warehouse',
                        titleAttribute: 'warehouse_name',
                        modifyQueryUsing: fn(Builder $query): Builder
                        => $query
                    )
                    ->grow(false)
                    ->required(),

                F\DatePicker::make('adjustment_date')
                    ->default(today())
                    ->maxDate(today())
                    ->grow(false)
                    ->required(),
            ])
                ->from('md')
                ->columnSpanFull(),

            S\Group::make([
                F\ToggleButtons::make('adjustment_status')
                    ->options(\App\Enums\OrderStatusEnum::class)
                    ->default(\App\Enums\OrderStatusEnum::Draft)
                    ->grouped()
                    ->required(),

                F\TextInput::make('reason')
                    ->required(),
            ]),

            __notes()
                ->rows(10),

        ];
    }

    /**
     * Các lot điều chỉnh
     */
    public static function linesInfo(): array
    {
        return [
            F\Repeater::make('lines')->hiddenLabel()
                ->schema([
                    F\Select::make('product_id')
                        ->label('Product')
                        ->options(fn() => \App\Models\Product::all()
                            ->pluck('product_description', 'id'))
                        ->getOptionLabelUsing(fn($value) => \App\Models\Product::find($value)?->product_description)
                        ->afterStateUpdated(fn(callable $set, $state) => static::populateDataFromProduct($state, $set))
                        ->preload()
                        ->searchable()
                        ->live()
                        ->disableOptionsWhenSelectedInSiblingRepeaterItems()
                        ->required(),

                    F\Hidden::make('product_life_cycle')
                        ->afterStateHydrated(fn(F\Field $component, callable $get)
                        => $component->state(\App\Models\Product::find($get('product_id'))?->product_life_cycle))
                        ->dehydrated(false),

                    F\Repeater::make('lots')
                        ->table([
                            F\Repeater\TableColumn::make('Lot No')
                                ->markAsRequired(),
                            F\Repeater\TableColumn::make('Mfg Date')
                                ->width('130px')
                                ->markAsRequired(),
                            F\Repeater\TableColumn::make('Exp Date')
                                ->width('130px')
                                ->markAsRequired(),
                            F\Repeater\TableColumn::make('Qty')
                                ->width('100px')
                                ->markAsRequired(),
                            F\Repeater\TableColumn::make('Price (VND)')
                                ->width('120px')
                                ->markAsRequired(),
                        ])
                        ->schema([
                            // Xác định lines khi chỉnh sửa
                            F\Hidden::make('id'),

                            F\TextInput::make('lot_no')
                                ->datalist(fn(callable $get) => \App\Models\InventoryTransaction::query()
                                    ->where('warehouse_id', $get('../../../../warehouse_id'))
                                    ->when($get('../../product_id'), fn(Builder $query, $productId)
                                    => $query->where('product_id', $productId))
                                    ->distinct()
                                    ->get()
                                    ->pluck('lot_fifo', 'lot_no')
                                    ->toArray())
                                ->distinct()
                                ->afterStateUpdated(fn($get, $set) => static::populateDataFromLot($get, $set))
                                ->live()
                                ->partiallyRenderComponentsAfterStateUpdated(['mfg_date', 'exp_date'])
                                ->rules([
                                    fn(Get $get): \Closure => function (string $attribute, $value, \Closure $fail) use ($get) {
                                        $lineId = $get('id');
                                        $exceptionIds = InventoryAdjustmentLine::find($lineId)?->transactions()
                                            ->pluck('id')->toArray();

                                        $qtyAdjustment = $get('adjustment_qty')
                                            ? __number_string_converter($get('adjustment_qty'), false)
                                            : null;

                                        // Kiểm tra lot_no đã tồn tại cho product + warehouse chưa
                                        if ($qtyAdjustment < 0) {
                                            $exists = \App\Models\InventoryTransaction::query()
                                                ->where('product_id', $get('../../product_id'))
                                                ->where('warehouse_id', $get('../../../../warehouse_id'))
                                                ->where('lot_no', $value)
                                                ->where('mfg_date', $get('mfg_date'))
                                                ->where('exp_date', $get('exp_date'))
                                                ->when($lineId, fn(Builder $query) => $query->whereNotIn('id', $exceptionIds))
                                                ->exists();

                                            if (!$exists) {
                                                $fail("Lot '{$value}' does not exist.");
                                            }
                                        }
                                    },
                                ])
                                ->required(),

                            F\DatePicker::make('mfg_date')
                                ->label(__('Mfg Date'))
                                ->maxDate(today())
                                ->afterStateUpdatedJs(fn(): string
                                => \App\Filament\Resources\PurchaseShipments\Schemas\PurchaseShipmentForm::setProductExpDateByJs())
                                ->required(),

                            F\DatePicker::make('exp_date')
                                ->label(__('Exp Date'))
                                ->required(),

                            __number_field('adjustment_qty', negative: true)
                                ->rules([
                                    fn(Get $get): \Closure
                                    => function (string $attribute, $value, \Closure $fail) use ($get) {
                                        $lotNo = $get('lot_no');
                                        $lineId = $get('id');

                                        $value = $value ? __number_string_converter($value, false) : null;

                                        // Kiểm tra tồn kho khi điều chỉnh giảm
                                        if ($value < 0) {
                                            $exceptionIds = InventoryAdjustmentLine::find($lineId)?->transactions()
                                                ->pluck('id')->toArray();

                                            $targetLot = \App\Models\InventoryTransaction::query()
                                                ->where('product_id', $get('../../product_id'))
                                                ->where('warehouse_id', $get('../../../../warehouse_id'))
                                                ->where('mfg_date', $get('mfg_date'))
                                                ->where('exp_date', $get('exp_date'))
                                                ->where('lot_no', $lotNo)
                                                ->when($lineId, fn(Builder $query) => $query->whereNotIn('id', $exceptionIds))
                                                ->first();

                                            $availableQty = $targetLot?->qty - $targetLot?->children()->sum('qty');

                                            if ($targetLot) {
                                                if ($value < 0 && abs($value) > $availableQty) {
                                                    $fail("Adjustment Qty cannot be greater than available quantity ({$availableQty}).");
                                                }
                                            }
                                        }
                                    },
                                ])
                                ->required(),

                            __number_field('io_price')
                                ->required(),
                        ])
                        ->compact()
                        ->minItems(1)
                        ->defaultItems(1)
                        ->addActionLabel(__('Add Lot/Batch')),

                ])
                ->itemLabel(function (array $state): ?string {
                    $product = \App\Models\Product::find($state['product_id']);
                    return $product ? $product->product_description :  __('Select a product');
                })
                ->addActionLabel(__('Add Product'))
        ];
    }

    // Helpers

    /**
     * Helper instance
     */
    protected static function helper(): Helpers\InventoryAdjustmentResourceHelper
    {
        return app(Helpers\InventoryAdjustmentResourceHelper::class);
    }

    /**
     * Populate data after product select
     */
    public static function populateDataFromProduct(?string $state, Set $set): void
    {
        // Reset lots
        $set('lots', [
            [
                'lot_no' => null,
                'mfg_date' => null,
                'exp_date' => null,
                'adjustment_qty' => null,
                'io_price' => null,
            ]
        ]);

        // Set product life cycle
        $product = \App\Models\Product::find($state);
        $set('product_life_cycle', $product?->product_life_cycle);
    }

    /**
     * Populate data after lot_no select
     */
    public static function populateDataFromLot(Get $get, Set $set): void
    {
        $warehouseId = $get('../../../../warehouse_id');
        $productId = $get('../../product_id');
        $lotNo = $get('lot_no');

        $transaction = \App\Models\InventoryTransaction::query()
            ->where('warehouse_id', $warehouseId)
            ->where('product_id', $productId)
            ->where('lot_no', $lotNo)
            ->first();

        if ($transaction) {
            $set('mfg_date', $transaction->mfg_date?->format('Y-m-d'));
            $set('exp_date', $transaction->exp_date?->format('Y-m-d'));
        } else {
            $set('mfg_date', null);
            $set('exp_date', null);
        }
    }
}
