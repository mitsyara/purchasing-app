<?php

namespace App\Filament\Resources\InventoryAdjustments\Helpers;

use App\Enums\InventoryTransactionDirectionEnum;
use App\Models\InventoryAdjustment;
use App\Models\InventoryAdjustmentLine;
use App\Models\InventoryTransaction;
use Filament\Actions\Action;
use Illuminate\Support\Facades\DB;

class InventoryAdjustmentResourceHelper
{
    /**
     * Đồng bộ dữ liệu cho action create/edit
     */
    public function syncData(Action $action, array $data): array
    {
        $adjustmentLines = $data['lines'] ?? [];

        $data['created_by'] ??= auth()->id();

        // Bỏ lines khỏi data
        unset($data['lines'], $data['id']);

        // Xử lý lines sau khi lưu record chính
        $action->after(function (InventoryAdjustment $record) use ($adjustmentLines) {
            $this->handleAdjustmentLines($record, $adjustmentLines);
        });

        return $data;
    }

    /**
     * Load dữ liệu cho form edit
     */
    public function loadFormData(InventoryAdjustment $record): array
    {
        // Load adjustment lines và nhóm theo product_id
        $lines = [];
        $groupedLines = $record->adjustmentsLines->groupBy('product_id');

        foreach ($groupedLines as $productId => $productLines) {
            $lots = [];

            foreach ($productLines as $line) {
                $lots[] = [
                    'id' => $line->id,
                    'lot_no' => $line->lot_no,
                    'mfg_date' => $line->mfg_date?->format('Y-m-d'),
                    'exp_date' => $line->exp_date?->format('Y-m-d'),
                    'adjustment_qty' => $line->adjustment_qty,
                    'io_price' => $line->io_price,
                ];
            }

            $lines[] = [
                'product_id' => $productId,
                'lots' => $lots
            ];
        }

        return [
            'company_id' => $record->company_id,
            'warehouse_id' => $record->warehouse_id,
            'adjustment_status' => $record->adjustment_status,
            'adjustment_date' => $record->adjustment_date?->format('Y-m-d'),
            'reason' => $record->reason,
            'notes' => $record->notes,
            'lines' => $lines,
        ];
    }

    /**
     * Xử lý adjustment lines và tạo inventory transactions
     * - Các adjustment lines chỉ xoá khi thực sự không còn (dựa vào field id)
     * - Nếu đổi lại Status về Canceled thì xoá các inventory transactions có liên quan đã tạo trước đó
     */
    protected function handleAdjustmentLines(InventoryAdjustment $adjustment, array $linesData): void
    {
        DB::transaction(function () use ($adjustment, $linesData) {
            // Lấy danh sách line IDs hiện tại
            $existingLineIds = $adjustment->adjustmentsLines()->pluck('id')->toArray();

            // Thu thập line IDs từ form data
            $submittedLineIds = [];
            foreach ($linesData as $lineData) {
                $lots = $lineData['lots'] ?? [];
                foreach ($lots as $lotData) {
                    if (!empty($lotData['id'])) {
                        $submittedLineIds[] = $lotData['id'];
                    }
                }
            }

            // Tìm lines cần xóa (có trong DB nhưng không có trong form)
            $lineIdsToDelete = array_diff($existingLineIds, $submittedLineIds);

            if (!empty($lineIdsToDelete)) {
                // Xóa transactions của lines bị xóa
                InventoryTransaction::where('sourceable_type', InventoryAdjustmentLine::class)
                    ->whereIn('sourceable_id', $lineIdsToDelete)
                    ->delete();

                // Xóa lines bị xóa
                InventoryAdjustmentLine::whereIn('id', $lineIdsToDelete)->delete();
            }

            // Xử lý từng line
            foreach ($linesData as $lineData) {
                $productId = $lineData['product_id'];
                $lots = $lineData['lots'] ?? [];

                foreach ($lots as $lotData) {
                    $qty = $lotData['adjustment_qty'];

                    // Nếu qty = 0, xóa line khỏi DB (nếu có)
                    if ($qty == 0) {
                        if (!empty($lotData['id'])) {
                            $lineToDelete = InventoryAdjustmentLine::find($lotData['id']);
                            if ($lineToDelete) {
                                // Xóa transaction trước
                                InventoryTransaction::where('sourceable_type', InventoryAdjustmentLine::class)
                                    ->where('sourceable_id', $lineToDelete->id)
                                    ->delete();

                                // Xóa line
                                $lineToDelete->delete();
                            }
                        }
                        // Bỏ qua, không tạo/update line này
                        continue;
                    }

                    if (!empty($lotData['id'])) {
                        // Cập nhật line existing (chỉ khi qty != 0)
                        $existingLine = InventoryAdjustmentLine::find($lotData['id']);
                        if ($existingLine) {
                            $existingLine->update([
                                'product_id' => $productId,
                                'lot_no' => $lotData['lot_no'],
                                'mfg_date' => $lotData['mfg_date'] ?? null,
                                'exp_date' => $lotData['exp_date'] ?? null,
                                'adjustment_qty' => $lotData['adjustment_qty'],
                                'io_price' => $lotData['io_price'] ?? null,
                            ]);

                            $this->handleLineTransaction($adjustment, $existingLine, $lotData);
                        }
                    } else {
                        // Tạo line mới (chỉ khi qty != 0)

                        $newLine = $adjustment->adjustmentsLines()->create([
                            'product_id' => $productId,
                            'lot_no' => $lotData['lot_no'],
                            'mfg_date' => $lotData['mfg_date'] ?? null,
                            'exp_date' => $lotData['exp_date'] ?? null,
                            'adjustment_qty' => $lotData['adjustment_qty'],
                            'io_price' => $lotData['io_price'] ?? null,
                        ]);

                        $this->handleLineTransaction($adjustment, $newLine, $lotData);
                    }
                }
            }
        });
    }

    /**
     * Xử lý inventory transaction cho adjustment line
     */
    protected function handleLineTransaction(
        InventoryAdjustment $adjustment,
        InventoryAdjustmentLine $adjustmentLine,
        array $lotData
    ): void {
        // Tìm transaction existing của line này
        $existingTransaction = InventoryTransaction::where('sourceable_type', InventoryAdjustmentLine::class)
            ->where('sourceable_id', $adjustmentLine->id)
            ->first();

        $qty = $lotData['adjustment_qty'];

        // Xử lý theo status
        if ($adjustment->adjustment_status === \App\Enums\OrderStatusEnum::Canceled) {
            // Status = Canceled: Xóa transaction
            if ($existingTransaction) {
                $existingTransaction->delete();
            }
            return;
        }

        // Chuẩn bị data cho transaction
        $transactionData = $this->prepareTransactionData($adjustment, $adjustmentLine, $qty);

        // Nếu qty < 0, tìm parent transaction phù hợp để gán làm child
        if ($qty < 0) {
            $parentTransaction = $this->findParentTransactionForExport($adjustment, $adjustmentLine);
            if ($parentTransaction) {
                $transactionData['parent_id'] = $parentTransaction->id;
            }
        }

        if ($existingTransaction) {
            // Cập nhật transaction existing
            $existingTransaction->update($transactionData);
        } else {
            // Tạo transaction mới
            InventoryTransaction::create(array_merge($transactionData, [
                'sourceable_id' => $adjustmentLine->id,
                'sourceable_type' => InventoryAdjustmentLine::class,
            ]));
        }
    }

    /**
     * Chuẩn bị dữ liệu cho inventory transaction
     */
    protected function prepareTransactionData(
        InventoryAdjustment $adjustment,
        InventoryAdjustmentLine $adjustmentLine,
        $qty
    ): array {
        // Xác định hướng transaction dựa trên qty
        $direction = $qty > 0
            ? InventoryTransactionDirectionEnum::Import
            : InventoryTransactionDirectionEnum::Export;

        // Xác định trạng thái checked dựa trên adjustment status
        $isChecked = false;
        $checkedBy = null;

        if ($adjustment->adjustment_status === \App\Enums\OrderStatusEnum::Completed) {
            $isChecked = true;
            $checkedBy = auth()->id();
        }

        return [
            'company_id' => $adjustment->company_id,
            'warehouse_id' => $adjustment->warehouse_id,
            'product_id' => $adjustmentLine->product_id,

            'transaction_direction' => $direction,
            'qty' => abs($qty), // Lưu qty dương

            'lot_no' => $adjustmentLine->lot_no,
            'mfg_date' => $adjustmentLine->mfg_date,
            'exp_date' => $adjustmentLine->exp_date,

            'io_price' => $adjustmentLine->io_price,
            'io_currency' => 'VND', // Mặc định VND
            'break_price' => $qty > 0 ? $adjustmentLine->io_price : null,

            'transaction_date' => $adjustment->adjustment_date,

            'is_checked' => $isChecked,
            'checked_by' => $checkedBy,

            'notes' => "{$adjustment->reason}",
        ];
    }

    /**
     * Tìm parent transaction phù hợp cho export transaction (qty < 0)
     * Ưu tiên theo thứ tự: FIFO (First In, First Out)
     */
    protected function findParentTransactionForExport(
        InventoryAdjustment $adjustment,
        InventoryAdjustmentLine $adjustmentLine
    ): ?InventoryTransaction {
        // Loại trừ transactions của chính adjustment này khi chỉnh sửa
        $existingAdjustmentLineIds = $adjustment->adjustmentsLines()
            ->pluck('id')
            ->toArray();

        // Tìm transaction import phù hợp có còn qty available
        return InventoryTransaction::query()
            ->where('warehouse_id', $adjustment->warehouse_id)
            ->where('product_id', $adjustmentLine->product_id)
            ->where('lot_no', $adjustmentLine->lot_no)
            ->where('mfg_date', $adjustmentLine->mfg_date)
            ->where('exp_date', $adjustmentLine->exp_date)
            ->where('transaction_direction', InventoryTransactionDirectionEnum::Import)
            ->where(function ($query) use ($existingAdjustmentLineIds) {
                $query->where('sourceable_type', '!=', InventoryAdjustmentLine::class)
                    ->orWhere(function ($subQuery) use ($existingAdjustmentLineIds) {
                        $subQuery->where('sourceable_type', InventoryAdjustmentLine::class)
                            ->whereNotIn('sourceable_id', $existingAdjustmentLineIds);
                    });
            })
            ->whereRaw('qty > COALESCE((SELECT SUM(qty) FROM inventory_transactions children WHERE children.parent_id = inventory_transactions.id), 0)')
            ->orderBy('transaction_date', 'asc') // FIFO: First In, First Out
            ->orderBy('id', 'asc')
            ->first();
    }
}
